name: Debug Secrets

on:
  workflow_dispatch:

jobs:
  debug:
    name: Debug Secrets Configuration
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check Secrets Availability
        run: |
          echo "=== Checking Secrets ==="

          # æ£€æŸ¥æœåŠ¡å™¨ç›¸å…³secrets
          if [ -n "${{ secrets.SERVER_HOST }}" ]; then
            echo "âœ… SERVER_HOST is set"
            echo "SERVER_HOST length: ${#SERVER_HOST}"
          else
            echo "âŒ SERVER_HOST is not set"
          fi

          if [ -n "${{ secrets.SERVER_USER }}" ]; then
            echo "âœ… SERVER_USER is set: ${{ secrets.SERVER_USER }}"
          else
            echo "âŒ SERVER_USER is not set"
          fi

          if [ -n "${{ secrets.SERVER_SSH_KEY }}" ]; then
            echo "âœ… SERVER_SSH_KEY is set"
            echo "SSH Key length: ${#SSH_KEY}"
            echo "SSH Key starts with: $(echo '${{ secrets.SERVER_SSH_KEY }}' | head -c 50)..."
          else
            echo "âŒ SERVER_SSH_KEY is not set"
          fi

          if [ -n "${{ secrets.SERVER_PORT }}" ]; then
            echo "âœ… SERVER_PORT is set: ${{ secrets.SERVER_PORT }}"
          else
            echo "âš ï¸ SERVER_PORT is not set (will use default 22)"
          fi

          # æ£€æŸ¥Supabaseç›¸å…³secrets
          if [ -n "${{ secrets.SUPABASE_URL }}" ]; then
            echo "âœ… SUPABASE_URL is set"
            echo "URL: ${{ secrets.SUPABASE_URL }}"
          else
            echo "âŒ SUPABASE_URL is not set"
          fi

          if [ -n "${{ secrets.SUPABASE_ANON_KEY }}" ]; then
            echo "âœ… SUPABASE_ANON_KEY is set"
            echo "Key length: ${#ANON_KEY}"
          else
            echo "âŒ SUPABASE_ANON_KEY is not set"
          fi

          if [ -n "${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}" ]; then
            echo "âœ… SUPABASE_SERVICE_ROLE_KEY is set"
            echo "Key length: ${#SERVICE_KEY}"
          else
            echo "âŒ SUPABASE_SERVICE_ROLE_KEY is not set"
          fi
        env:
          SERVER_HOST: ${{ secrets.SERVER_HOST }}
          SSH_KEY: ${{ secrets.SERVER_SSH_KEY }}
          ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
          SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}

      - name: Test SSH Key Format
        if: ${{ secrets.SERVER_SSH_KEY }}
        run: |
          echo "=== Testing SSH Key Format ==="

          # å°†SSHå¯†é’¥å†™å…¥ä¸´æ—¶æ–‡ä»¶
          echo '${{ secrets.SERVER_SSH_KEY }}' > /tmp/test_key

          # æ£€æŸ¥å¯†é’¥æ ¼å¼
          if ssh-keygen -l -f /tmp/test_key; then
            echo "âœ… SSH key format is valid"
          else
            echo "âŒ SSH key format is invalid"
            echo "Key content preview:"
            head -n 1 /tmp/test_key
            tail -n 1 /tmp/test_key
          fi

          # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
          rm -f /tmp/test_key

      - name: Test Network Connectivity
        if: ${{ secrets.SERVER_HOST }}
        run: |
          echo "=== Testing Network Connectivity ==="

          # æµ‹è¯•pingè¿é€šæ€§
          if ping -c 3 ${{ secrets.SERVER_HOST }}; then
            echo "âœ… Server is reachable via ping"
          else
            echo "âŒ Server is not reachable via ping"
          fi

          # æµ‹è¯•SSHç«¯å£
          if nc -zv ${{ secrets.SERVER_HOST }} ${{ secrets.SERVER_PORT || 22 }}; then
            echo "âœ… SSH port is open"
          else
            echo "âŒ SSH port is not accessible"
          fi

      - name: Test SSH Connection
        if: ${{ secrets.SERVER_HOST && secrets.SERVER_USER && secrets.SERVER_SSH_KEY }}
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ secrets.SERVER_PORT || 22 }}
          debug: true
          timeout: 30s
          script: |
            echo "ğŸ‰ SSH connection successful!"
            echo "Server: $(hostname)"
            echo "User: $(whoami)"
            echo "Date: $(date)"
            echo "Working directory: $(pwd)"
